defaults: &defaults
  docker:
    - image: node:9

  working_directory: ~/repo





jobs:
  checkout:
    <<: *defaults

    steps:
      - restore_cache:
          name: Restore Repository Cache
          keys:
            - repo-{{ .Environment.CIRCLE_SHA1 }}
            - repo-

      - checkout

      - save_cache:
          name: Save Repository Cache
          key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ~/repo

  install-dependencies:
    <<: *defaults

    steps:
      - restore_cache:
          name: Restore Repository Cache
          keys:
            - repo-{{ .Environment.CIRCLE_SHA1 }}

      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-{{ .Branch }}-{{ checksum "yarn.lock" }}
            - yarn-{{ .Branch }}
            - yarn-master
            - yarn-

      - run:
          name: Install Dependencies
          command: yarn install

      - save_cache:
          name: Save Yarn Package Cache
          key: yarn-{{ .Branch }}-{{ checksum "yarn.lock" }}
          paths:
            - node_modules

  build:
    <<: *defaults

    steps:
      - checkout

      - restore_cache:
          name: Restore Repository Cache
          keys:
            - repo-{{ .Environment.CIRCLE_SHA1 }}

      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-{{ .Branch }}-{{ checksum "yarn.lock" }}

      - restore_cache:
          name: Restore Build Cache
          keys:
            - build-{{ .Environment.CIRCLE_SHA1 }}
            - build-

      - run:
          name: Build Application
          command: yarn run build

      - save_cache:
          name: Save Build Cache
          key: build-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - .next

  test:
    <<: *defaults

    steps:
      - restore_cache:
          name: Restore Repository Cache
          keys:
            - repo-{{ .Environment.CIRCLE_SHA1 }}

      - restore_cache:
          name: Restore Yarn Package Cache
          keys:
            - yarn-{{ .Branch }}-{{ checksum "yarn.lock" }}

      - restore_cache:
          name: Restore Build Cache
          keys:
            - build-{{ .Environment.CIRCLE_SHA1 }}

      - run:
          name: Run tests
          command: yarn test

  # pre-deploy:
  #   <<: *defaults

  #   steps:
  #     - add_ssh_keys

  #     - run:
  #         name: Keyscan (HACK)
  #         command: ssh-keyscan -H $DEV_DEPLOY_HOST >> ~/.ssh/known_hosts

  #     - run:
  #         name: Install rsync
  #         command: sudo apt-get update -qq && sudo apt-get install -y rsync

  # dev-deploy:
  #   <<: *defaults

  #   steps:
  #     - run:
  #         name: Deploy to dev.rollforguild.com
  #         command: rsync -r --delete-after --quiet ~/repo/ $DEV_DEPLOY_USER@$DEV_DEPLOY_HOST:$DEV_DEPLOY_FOLDER

  # prod-deploy:
  #   <<: *defaults

  #   steps:
  #     - run:
  #         name: Deploy to rollforguild.com
  #         command: rsync -r --delete-after --quiet ~/repo/ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_FOLDER





workflows:
  version: 2

  deploy-to-dev:
    jobs:
      - checkout
      - install-dependencies:
          requires:
            - checkout
      - build:
          requires:
            - install-dependencies
      - test:
          requires:
            - build
      # - dev-deploy:
      #     requires:
      #       - test
      #     filters:
      #       branches:
      #         only: develop
      # - prod-deploy:
      #     requires:
      #       - test
      #     filters:
      #       branches:
      #         only: master
